---
title: "Final Project:  Clustering Analysis"
author: "Katherine M. Prioli"
date: "December 05, 2019"
output:
  pdf_document: default
  html_document: default
geometry: margin = 0.5in
---


## GENERATING CORRELATION PLOTS FOR BMI VS CONTINUOUS AND ORDINAL VARIABLES

```{r corrplots, eval = FALSE, echo = FALSE, paged.print = FALSE, fig.width = 9, fig.height = 6}
# Change chunk options to eval = TRUE if I want to generate these (they're a bit computationally intense)

demog_corrplot <- ggpairs(nhanes_unsup_tbl, 
                          columns = c("BMI_cat", "age", "educ", "famincome_cat", "n_comorbid"),
                          columnLabels = c("BMI Category", "Age", "Education", "Fam. Income", "No. Comorbidities"),
                          title = "BMI Category vs. Demographics and Comorbidities")
demog_corrplot

behav_corrplot <- ggpairs(nhanes_unsup_tbl,
                          columns = c("BMI_cat", "mins_activ", "mins_seden", "dailykcal", "dailywater"),
                          columnLabels = c("BMI Category", "Mins. Active", "Mins. Sedentary", "Caloric Intake", "Water Intake"),
                          title = "BMI Category vs. Behavioral Variables")
behav_corrplot
```


## GENERATING DISSIMILARITY MATRIX

```{r dissim, echo = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 6}
dissim_mat <- vegdist(nhanes_unsup_mat, method = "gower")

# Descriptives for the dissimilarity matrix
summary(dissim_mat) %>% 
  round(digits = 2) %>% 
  tidy() %>% 
  setNames(., c("Min", "Q1", "Median", "Mean", "Q3", "Max")) %>% 
  kable(format = "markdown")
```


## GENERATING INITIAL NON-CLUSTERED DENDROGRAMS WITH 4-LEVEL BMI CATEGORY LEAF LABELS

```{r agnes_diana, echo = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 6}
nhanes_agnes <- hclust(d = dissim_mat, method = "ward.D2")   # ward.D2 performs agglomerative per hclust documentation

nhanes_diana <- diana(x = (dissim_mat %>% as.matrix()), diss = TRUE, keep.diss = TRUE) %>% 
  as.hclust()
```

```{r agnes_dend, warning = FALSE, message = FALSE, echo = FALSE, paged.print = FALSE, fig.width = 6.5, fig.height = 6.5}
ggthemr("flat", spacing = 0.1)

unsup_labs_reord_ag <- unsup_labs[nhanes_agnes$order] %>%    # Reordering leaf labels
  str_sub(start = 1L, end = 1L) %>% 
  as_tibble() %>% 
  mutate(
    BMI_cat = case_when(   # Modifying leaf labels to show BMI category abbreviations
      value == "1" ~ "UW",        # Underweight
      value == "2" ~ "HW",        # Healthy weight
      value == "3" ~ "OW",        # Overweight
      value == "4" ~ "OB"         # Obese
      ),
    BMI_dichot = case_when(
      value %in% c(1, 2) ~ "UW/HW",
      value %in% c(3, 4) ~ "OW/OB"
    )) %>% 
  select(BMI_cat, BMI_dichot) %>% 
  as_tibble() %>% 
  mutate(x = row_number(),
         labcolor = case_when(   # Have decided not to use text labels but keeping this here in case I change my mind
           BMI_cat == "UW" ~ "#B0B000",               # Yellow
           BMI_cat == "HW" ~ "#008318",               # Green
           BMI_cat == "OW" ~ "#FF8D03",               # Orange
           BMI_cat == "OB" ~ "#FF0000"),              # Red
         leafcolor = case_when(
           BMI_cat == "UW" ~ "#FFFF00",               # Yellow
           BMI_cat == "HW" ~ "#008318",               # Green
           BMI_cat == "OW" ~ "#FF8D03",               # Orange
           BMI_cat == "OB" ~ "#FF0000"),              # Red
         leafcolor_dichot = case_when(
           BMI_dichot == "UW/HW" ~ "#008318",         # Green
           BMI_dichot == "OW/OB" ~ "#FF0000")) %>%    # Red
  select(x, BMI_cat, BMI_dichot, labcolor, leafcolor, leafcolor_dichot)

ag_labcolors <- unsup_labs_reord_ag

agnes_dend <- nhanes_agnes %>% 
  as.dendrogram() %>% 
  set("leaves_pch", 20, col = ag_labcolors$leafcolor) %>% 
  set("leaves_col", ag_labcolors$leafcolor) %>% 
  set("branches_lwd", 0.5)

agnes_dend_ggd <- agnes_dend %>% 
  as.ggdend()

agnes_dend_gg <- ggplot(agnes_dend_ggd, labels = FALSE) +
  scale_y_reverse() +
  coord_polar(theta = "x") +
  theme(text = element_text(face = "bold"),
        axis.line = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        plot.title = element_text(angle = 0)) +
  xlab("") +
  ylab("")
agnes_dend_gg

ggthemr("flat")
```


### Generating plot legends for use in final report

```{r legend_gen, warning = FALSE, message = FALSE, echo = FALSE, paged.print = FALSE, fig.width = 7.5, fig.height = 6.5}
# Creating legends for radial dendrogram plots

legend_tbl <- unsup_labs_reord_ag %>% 
  mutate(
    BMI_cat = case_when(
      BMI_cat == "UW" ~ "Underweight",
      BMI_cat == "HW" ~ "Healthy Weight",
      BMI_cat == "OW" ~ "Overweight",
      BMI_cat == "OB" ~ "Obese"),
    BMI_dichot = case_when(
      BMI_dichot == "UW/HW" ~ "Not Overweight \nor Obese",
      BMI_dichot == "OW/OB" ~ "Overweight \nor Obese")) %>% 
  mutate(BMI_cat = factor(BMI_cat, levels = c("Underweight", "Healthy Weight", "Overweight", "Obese")),
         BMI_dichot = factor(BMI_dichot, levels = c("Not Overweight \nor Obese", "Overweight \nor Obese"))) %>% 
  select(-labcolor, -x) %>% 
  unique() %>%
  arrange(BMI_cat) %>% 
  mutate(x = 0, y = 0)

ggthemr("flat")
ggleg <- ggplot(data = legend_tbl, aes(x = x, y = y)) +
  geom_point(aes(x = x, y = y, fill = BMI_cat), color = "#545454", shape = "circle filled", size = 3) +
  scale_fill_manual(name = "BMI Category",
                    values = c(Underweight = "#FFFF00",
                               "Healthy Weight" = "#008318",
                               Overweight = "#FF8D03",
                               Obese = "#FF0000")) +
  theme(axis.line = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_rect(fill = "white"),
        legend.key = element_rect(fill = "white"),
        #legend.position = "bottom",
        panel.background = element_blank(),
        panel.grid = element_blank(),
        plot.background = element_blank(),
        plot.title = element_text(angle = 0)) +
  xlab("") +
  ylab("")
save_plot(filename = "report/ggleg.svg", plot = ggleg, base_height = 8.5, base_width = 8.5)
ggleg_svg <- image_read_svg("report/ggleg.svg")

ggleg_dichot <- ggplot(data = legend_tbl, aes(x = x, y = y)) +
  geom_point(aes(x = x, y = y, fill = BMI_dichot), color = "#545454", shape = "circle filled", size = 3) +
  scale_fill_manual(name = "Dichotomous \nBMI Category",
                    values = c("Not Overweight \nor Obese" = "#008318",
                               "Overweight \nor Obese" = "#FF0000")) +
  theme(axis.line = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_rect(fill = "white"),
        legend.key = element_rect(fill = "white"),
        #legend.position = "bottom",
        panel.background = element_blank(),
        panel.grid = element_blank(),
        plot.background = element_blank(),
        plot.title = element_text(angle = 0)) +
  xlab("") +
  ylab("")
save_plot(filename = "report/ggleg_dichot.svg", plot = ggleg_dichot, base_height = 8.5, base_width = 8.5)
ggleg_dichot_svg <- image_read_svg("report/ggleg_dichot.svg")
```

```{r diana_dend, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.5, fig.height = 6.5}
ggthemr("flat", spacing = 0.1)

unsup_labs_reord_di <- unsup_labs[nhanes_diana$order] %>%    # Reordering leaf labels
  str_sub(start = 1L, end = 1L) %>% 
  as_tibble() %>% 
  mutate(
    BMI_cat = case_when(   # Modifying leaf labels to show BMI category abbreviations
      value == "1" ~ "UW",        # Underweight
      value == "2" ~ "HW",        # Healthy weight
      value == "3" ~ "OW",        # Overweight
      value == "4" ~ "OB"         # Obese
      ),
    BMI_dichot = case_when(
      value %in% c(1, 2) ~ "UW/HW",
      value %in% c(3, 4) ~ "OW/OB"
    )) %>% 
  select(BMI_cat, BMI_dichot) %>% 
  as_tibble() %>% 
  mutate(x = row_number(),
         labcolor = case_when(   # Have decided not to use text labels but keeping this here in case I change my mind
           BMI_cat == "UW" ~ "#B0B000",               # Yellow
           BMI_cat == "HW" ~ "#008318",               # Green
           BMI_cat == "OW" ~ "#FF8D03",               # Orange
           BMI_cat == "OB" ~ "#FF0000"),              # Red
         leafcolor = case_when(
           BMI_cat == "UW" ~ "#FFFF00",               # Yellow
           BMI_cat == "HW" ~ "#008318",               # Green
           BMI_cat == "OW" ~ "#FF8D03",               # Orange
           BMI_cat == "OB" ~ "#FF0000"),              # Red
         leafcolor_dichot = case_when(
           BMI_dichot == "UW/HW" ~ "#008318",         # Green
           BMI_dichot == "OW/OB" ~ "#FF0000")) %>%    # Red
  select(x, BMI_cat, BMI_dichot, labcolor, leafcolor, leafcolor_dichot)

di_labcolors <- unsup_labs_reord_di

diana_dend <- nhanes_diana %>% 
  as.dendrogram() %>% 
  set("leaves_pch", 20, col = di_labcolors$leafcolor) %>% 
  set("leaves_col", di_labcolors$leafcolor) %>% 
  set("branches_lwd", 0.5)

diana_dend_ggd <- diana_dend %>% 
  as.ggdend()

diana_dend_gg <- ggplot(diana_dend_ggd, labels = FALSE) +
  scale_y_reverse() +
  coord_polar(theta = "x") +
  theme(text = element_text(face = "bold"),
        axis.line = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        plot.title = element_text(angle = 0)) +
  xlab("") +
  ylab("")
diana_dend_gg

ggthemr("flat")
```


## USING CLUSTER STATISTICS TO GENERATE CLUSTER SIZE, SCREE, AND SILHOUETTE PLOTS

```{r clust_sizes, warning = FALSE, echo = FALSE, paged.print = FALSE, fig.width = 12, fig.height = 4}
maxheight = rbind(agnes_sizes$cluster_size, diana_sizes$cluster_size) %>% 
  max()
ymax = ceiling(maxheight / 5) * 5

agnes_clustsize <- ggplot(data = agnes_sizes, aes(x = cluster_no, y = cluster_size)) +
  geom_col() +
  scale_x_continuous(breaks = c(0:15)) +
  ylim(0, ymax) +
  xlab("Cluster Number") +
  ylab("Cluster Size") +
  ggtitle("AGNES")

agnes_sizedesc <- summary(agnes_sizes$cluster_size) %>% 
  round(digits = 2) %>% 
  tidy() %>% 
  setNames(., c("Min", "Q1", "Median", "Mean", "Q3", "Max")) %>% 
  t() %>% 
  tableGrob(theme = ttheme_minimal(base_size = 10, padding = unit(c(2, 2), "mm")))

diana_clustsize <- ggplot(data = diana_sizes, aes(x = cluster_no, y = cluster_size)) +
  geom_col() +
  scale_x_continuous(breaks = c(0:15)) +
  ylim(0, ymax) +
  xlab("Cluster Number") +
  ylab("Cluster Size") +
  ggtitle("DIANA")

diana_sizedesc <- summary(diana_sizes$cluster_size) %>% 
  round(digits = 2) %>% 
  tidy() %>% 
  setNames(., c("Min", "Q1", "Median", "Mean", "Q3", "Max")) %>% 
  t() %>% 
  tableGrob(theme = ttheme_minimal(base_size = 10, padding = unit(c(2, 2), "mm")))

grid.arrange(agnes_sizedesc, agnes_clustsize, textGrob(" "), diana_sizedesc, diana_clustsize, 
             nrow = 1, ncol = 5, widths = c(0.25, 0.7, 0.1, 0.25, 0.7),
             top = textGrob("Cluster Sizes, k = 15 Clusters, Hierarchical Clustering Analysis",
                            gp = gpar(fontsize = 16, fontface = "bold", col = "#34495E"),
                            x = 0.025, hjust = 0))
```

```{r scree, echo = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 4}
agnes_scree <- ggplot(data = agnes_statdata, aes(x = n_clusters, y = withinss)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = c(0:15)) +
  xlab("Number of Clusters") +
  ylab("Within-Cluster Sum of Squares") +
  ggtitle("AGNES")

diana_scree <- ggplot(data = diana_statdata, aes(x = n_clusters, y = withinss)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = c(0:15)) +
  xlab("Number of Clusters") +
  ylab("Within-Cluster Sum of Squares") +
  ggtitle("DIANA")

screes <- grid.arrange(agnes_scree, diana_scree, nrow = 1,
                       top = textGrob("Scree Plots",
                                      gp = gpar(fontsize = 16, fontface = "bold", col = "#34495E"),
                                      x = 0.025, hjust = 0))
screes
```

```{r silhou, echo = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 4}
agnes_sil <- ggplot(data = agnes_statdata, aes(x = n_clusters, y = asw)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = c(0:15)) +
  xlab("Number of Clusters") +
  ylab("Average Silhouette Width") +
  ggtitle("AGNES")

diana_sil <- ggplot(data = diana_statdata, aes(x = n_clusters, y = asw)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = c(0:15)) +
  xlab("Number of Clusters") +
  ylab("Average Silhouette Width") +
  ggtitle("DIANA")

sils <- grid.arrange(agnes_sil, diana_sil, nrow = 1,
                     top = textGrob("Silhouette Plots",
                                    gp = gpar(fontsize = 16, fontface = "bold", col = "#34495E"),
                                    x = 0.025, hjust = 0))
sils
```


## EXTRACTING CLUSTER N, % IN EACH BMI CATEGORY (BOTH 4-LEVEL AND DICHOTOMOUS)

```{r leaves_segs, include = FALSE, echo = FALSE}
cluster_clusts <- function(df, dichot = FALSE){   # dichot = 0 for 4-level BMI category, dichot = 1 for dichotomous; defaults to 4-level
  leaves <- df$nodes %>% 
    filter(leaf == TRUE) %>% 
    select(x, col) %>% 
    rename(BMI_cat = col)
  
  if(dichot == FALSE){
    leaves <- leaves %>% 
      mutate(
        BMI_cat = case_when(
          BMI_cat == "#FFFF00" ~ "Underweight",
          BMI_cat == "#008318" ~ "Healthy Weight",
          BMI_cat == "#FF8D03" ~ "Overweight",
          BMI_cat == "#FF0000" ~ "Obese"),
        BMI_cat = factor(BMI_cat, levels = c("Underweight", "Healthy Weight", "Overweight", "Obese"))) %>% 
      select(x, BMI_cat)
  }
  
  if(dichot == TRUE){
    leaves <- leaves %>% 
      mutate(
        BMI_cat = case_when(
          BMI_cat == "#008318" ~ "Not Overweight or Obese",
          BMI_cat == "#FF0000" ~ "Overweight or Obese"),
        BMI_cat = factor(BMI_cat, levels = c("Not Overweight or Obese", "Overweight or Obese"))) %>% 
      select(x, BMI_cat)
  }
  
  segs <- df$segments %>% 
    filter(yend == 0) %>% 
    select(x, col) %>% 
    rename(cluster_col = col)
  
  clusts <- leaves %>% 
    full_join(segs, by = "x") %>% 
    mutate(cluster_num = group_indices(., factor(cluster_col, levels = unique(cluster_col)))) %>%   # Numbering clusters
    group_by(cluster_num) %>%
    mutate(n_in_clust = n()) %>% 
    group_by(cluster_num, BMI_cat) %>% 
    mutate(n_cat_in_clust = n()) %>% 
    ungroup()
  
  clusts
}
```

```{r cluster_num_labs}
cluster_labs <- function(df, dichot = FALSE){   # dichot = 0 for 4-level BMI category, dichot = 1 for dichotomous; defaults to 4-level
  clust_labs <- cluster_clusts(df, dichot) %>% 
    mutate(cluster_num = paste0("Cluster #", cluster_num)) %>% 
    group_by(cluster_num) %>% 
    mutate(x_lab = mean(x)) %>%
    ungroup() %>% 
    select(x_lab, cluster_num, cluster_col) %>% 
    unique()
  
  clust_labs
}
```

```{r cluster_pct, include = FALSE, echo = FALSE}
cluster_pct <- function(df, dichot = FALSE){   # dichot = 0 for 4-level BMI category, dichot = 1 for dichotomous; defaults to 4-level
  clusts <- cluster_clusts(df, dichot) %>% 
    select(cluster_num, n_in_clust, BMI_cat, n_cat_in_clust) %>% 
    unique() %>% 
    arrange(cluster_num, BMI_cat) %>% 
    rename(Size = n_in_clust) %>% 
    mutate(pct_cat_in_clust = round((n_cat_in_clust / Size) * 100, digits = 1),
           n_pct = paste0(n_cat_in_clust, " (", pct_cat_in_clust, "%)"),
           BMI_cat = paste0(BMI_cat, " (n, %)"))
  
  if(dichot == FALSE){
    clusts <- clusts %>% 
      mutate(BMI_cat = factor(BMI_cat, levels = c("Underweight (n, %)",
                                                "Healthy Weight (n, %)",
                                                "Overweight (n, %)",
                                                "Obese (n, %)")))
  }
  
  if(dichot == TRUE){
    clusts <- clusts %>% 
      mutate(BMI_cat = factor(BMI_cat, levels = c("Not Overweight or Obese (n, %)",
                                                  "Overweight or Obese (n, %)")))
  }
  
  clusts <- clusts %>% 
    rename("Size (n)" = Size) %>% 
    select(cluster_num, "Size (n)", BMI_cat, n_pct) %>% 
    spread(BMI_cat, n_pct, fill = "0 (0%)")
  }
```


## INITIAL CLUSTERING DENDROGRAMS WITH 4-LEVEL BMI

```{r agnes_dend_clust_ggd_init, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.5, fig.height = 6.5}
# 7 clusters for AGNES
agnes_dend_clust_init <- nhanes_agnes %>% 
  as.dendrogram() %>% 
  set("leaves_pch", 20, col = ag_labcolors$leafcolor) %>% 
  set("leaves_col", ag_labcolors$leafcolor) %>% 
  set("branches_lwd", 0.5) %>% 
  set("branches_k_col", k = 7, c("#3498DB",    # Blue
                                 "#2ECC71",    # Green
                                 "#F39C12",    # Gold/orange
                                 "#E74C3C",    # Red
                                 "#D979C9",    # Pink
                                 "#9B59B6",    # Purple
                                 #"#9F83D4",    # Grape
                                 "#1ABCB4")) #,    # Teal
                                 #"#45A37C",    # Sage green
                                 #"#34495E"))   # Slate blue

agnes_dend_clust_init_ggd <- agnes_dend_clust_init %>% 
  as.ggdend()
```

```{r agnes_init_cluster_characteristics, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 4}
ag_init_clusts_kbl <- cluster_pct(agnes_dend_clust_init_ggd) %>%
  rename(Cluster = cluster_num) %>%
  kable(format = "markdown", align = "rrrrrr")

ag_init_clust_labs <- cluster_labs(agnes_dend_clust_init_ggd)
```

```{r agnes_dend_clust_init, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.75, fig.height = 6.75}
ggthemr("flat", spacing = 0.1)

agnes_dend_clust_init_gg <- ggplot(agnes_dend_clust_init_ggd, labels = FALSE) +
  geom_text(data = ag_init_clust_labs, aes(x = x_lab, y = -0.5, label = cluster_num, color = cluster_col)) +
  scale_y_reverse() +
  coord_polar(theta = "x") +
  theme(axis.line = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +
  xlab("") +
  ylab("")
agnes_dend_clust_init_gg

ggthemr("flat")
```

```{r diana_dend_clust_ggd_init, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.5, fig.height = 6.5}
# 6 clusters for DIANA
di_labcolors <- unsup_labs_reord_di %>% 
  as_tibble()

diana_dend_clust_init <- nhanes_diana %>% 
  as.dendrogram() %>% 
  set("leaves_pch", 20, col = di_labcolors$leafcolor) %>% 
  set("leaves_col", di_labcolors$leafcolor) %>% 
  set("branches_lwd", 0.5) %>% 
  set("branches_k_col", k = 6, c("#3498DB",    # Blue
                                 "#2ECC71",    # Green
                                 "#F39C12",    # Gold/orange
                                 "#E74C3C",    # Red
                                 "#D979C9",    # Pink
                                 "#9B59B6"))#,    # Purple
                                 #"#9F83D4",    # Grape
                                 #"#1ABCB4",    # Teal
                                 #"#45A37C",    # Sage green
                                 #"#34495E"))   # Slate blue

diana_dend_clust_init_ggd <- diana_dend_clust_init %>% 
  as.ggdend()
```

```{r diana_init_cluster_characteristics, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 4}
di_init_clusts_kbl <- cluster_pct(diana_dend_clust_init_ggd) %>% 
  rename(Cluster = cluster_num) %>% 
  kable(format = "markdown", align = "rrrrrr")

di_init_clust_labs <- cluster_labs(diana_dend_clust_init_ggd)
```

```{r diana_dend_clust_init, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.75, fig.height = 6.75}
diana_dend_clust_init_gg <- ggplot(diana_dend_clust_init_ggd, labels = FALSE) +
  geom_text(data = di_init_clust_labs, aes(x = x_lab, y = -0.15, label = cluster_num, color = cluster_col)) +
  scale_y_reverse() +
  coord_polar(theta = "x") +
  theme(axis.line = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +
  xlab("") +
  ylab("")
diana_dend_clust_init_gg

ggthemr("flat")
```


## REVISED CLUSTERING DENDROGRAMS, DICHOTOMOUS BMI, NO CHANGE TO *k*

```{r agnes_dend_clust_ggd_dichot, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.5, fig.height = 6.5}
# 7 clusters for AGNES; dichotomous BMI category
agnes_dend_clust_dichot <- nhanes_agnes %>% 
  as.dendrogram() %>% 
  set("leaves_pch", 20, col = ag_labcolors$leafcolor_dichot) %>% 
  set("leaves_col", ag_labcolors$leafcolor_dichot) %>% 
  set("branches_lwd", 0.5) %>% 
  set("branches_k_col", k = 7, c("#3498DB",    # Blue
                                 "#2ECC71",    # Green
                                 "#F39C12",    # Gold/orange
                                 "#E74C3C",    # Red
                                 "#D979C9",    # Pink
                                 "#9B59B6",    # Purple
                                 #"#9F83D4",    # Grape
                                 "#1ABCB4")) #,    # Teal
                                 #"#45A37C",    # Sage green
                                 #"#34495E"))   # Slate blue

agnes_dend_clust_dichot_ggd <- agnes_dend_clust_dichot %>% 
  as.ggdend()
```

```{r agnes_dichot_cluster_characteristics, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 4}
ag_dichot_clusts_kbl <- cluster_pct(agnes_dend_clust_dichot_ggd, dichot = TRUE) %>%
  rename(Cluster = cluster_num) %>%
  kable(format = "markdown", align = "rrrr")

ag_dichot_clust_labs <- cluster_labs(agnes_dend_clust_dichot_ggd, dichot = TRUE)
```

```{r agnes_dend_clust_dichot, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.75, fig.height = 6.75}
ggthemr("flat", spacing = 0.1)

agnes_dend_clust_dichot_gg <- ggplot(agnes_dend_clust_dichot_ggd, labels = FALSE) +
  geom_text(data = ag_dichot_clust_labs, aes(x = x_lab, y = -0.5, label = cluster_num, color = cluster_col)) +
  scale_y_reverse() +
  coord_polar(theta = "x") +
  theme(axis.line = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +
  xlab("") +
  ylab("")
agnes_dend_clust_dichot_gg

ggthemr("flat")
```

```{r diana_dend_clust_ggd_dichot, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.5, fig.height = 6.5}
# 6 clusters for DIANA; dichotomous BMI category
di_labcolors <- unsup_labs_reord_di %>% 
  as_tibble()

diana_dend_clust_dichot <- nhanes_diana %>% 
  as.dendrogram() %>% 
  set("leaves_pch", 20, col = di_labcolors$leafcolor_dichot) %>% 
  set("leaves_col", di_labcolors$leafcolor_dichot) %>% 
  set("branches_lwd", 0.5) %>% 
  set("branches_k_col", k = 6, c("#3498DB",    # Blue
                                 "#2ECC71",    # Green
                                 "#F39C12",    # Gold/orange
                                 "#E74C3C",    # Red
                                 "#D979C9",    # Pink
                                 "#9B59B6"))#,    # Purple
                                 #"#9F83D4",    # Grape
                                 #"#1ABCB4",    # Teal
                                 #"#45A37C",    # Sage green
                                 #"#34495E"))   # Slate blue

diana_dend_clust_dichot_ggd <- diana_dend_clust_dichot %>% 
  as.ggdend()
```

```{r diana_dichot_cluster_characteristics, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 4}
di_dichot_clusts_kbl <- cluster_pct(diana_dend_clust_dichot_ggd, dichot = TRUE) %>% 
  rename(Cluster = cluster_num) %>% 
  kable(format = "markdown", align = "rrrr")

di_dichot_clust_labs <- cluster_labs(diana_dend_clust_dichot_ggd, dichot = TRUE)
```

```{r diana_dend_clust_dichot, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.75, fig.height = 6.75}
diana_dend_clust_dichot_gg <- ggplot(diana_dend_clust_dichot_ggd, labels = FALSE) +
  geom_text(data = di_dichot_clust_labs, aes(x = x_lab, y = -0.15, label = cluster_num, color = cluster_col)) +
  scale_y_reverse() +
  coord_polar(theta = "x") +
  theme(axis.line = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +
  xlab("") +
  ylab("")
diana_dend_clust_dichot_gg

ggthemr("flat")
```


## REVISED CLUSTERING DENDROGRAMS, DICHOTOMOUS BMI, INCREASED *k*

```{r agnes_dend_clust_dichot_rev_ggd, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.5, fig.height = 6.5}
# 10 clusters for AGNES; dichotomous BMI weight category
agnes_dend_clust_dichot_rev <- nhanes_agnes %>%
  as.dendrogram() %>%
  set("leaves_pch", 20, col = ag_labcolors$leafcolor_dichot) %>%
  set("leaves_col", ag_labcolors$leafcolor_dichot) %>%
  set("branches_lwd", 0.5) %>%
  set("branches_k_col", k = 10, c("#3498DB",   # Blue
                                  "#2ECC71",    # Green
                                  "#F39C12",    # Gold/orange
                                  "#E74C3C",    # Red
                                  "#D979C9",    # Pink
                                  "#9B59B6",    # Purple
                                  "#9F83D4",    # Grape
                                  "#1ABCB4",    # Teal
                                  "#45A37C",    # Sage green
                                  "#34495E"))   # Slate blue

agnes_dend_clust_dichot_rev_ggd <- agnes_dend_clust_dichot_rev %>%
  as.ggdend()
```

```{r agnes_dichot_rev_cluster_characteristics, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 4}
ag_dichot_rev_clusts_kbl <- cluster_pct(agnes_dend_clust_dichot_rev_ggd, dichot = TRUE) %>%
  rename(Cluster = cluster_num) %>%
  kable(format = "markdown", align = "rrrr")

ag_rev_clust_labs <- cluster_labs(agnes_dend_clust_dichot_rev_ggd)
```

```{r agnes_dend_clust_dichot_rev, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.75, fig.height = 6.75}
ggthemr("flat", spacing = 0.1)

agnes_dend_clust_dichot_rev_gg <- ggplot(agnes_dend_clust_dichot_rev_ggd, labels = FALSE) +
  geom_text(data = ag_rev_clust_labs, aes(x = x_lab, y = -0.5, label = cluster_num, color = cluster_col)) +
  scale_y_reverse() +
  coord_polar(theta = "x") +
  theme(axis.line = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +
  xlab("") +
  ylab("")
agnes_dend_clust_dichot_rev_gg

ggthemr("flat")
```

```{r diana_dend_clust_dichot_rev_ggd, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.5, fig.height = 6.5}
# 9 clusters for DIANA; dichotomous BMI weight category
diana_dend_clust_dichot_rev <- nhanes_diana %>%
  as.dendrogram() %>%
  set("leaves_pch", 20, col = di_labcolors$leafcolor_dichot) %>%
  set("leaves_col", di_labcolors$leafcolor_dichot) %>%
  set("branches_lwd", 0.5) %>%
  set("branches_k_col", k = 9, c("#3498DB",   # Blue
                                 "#2ECC71",    # Green
                                 "#F39C12",    # Gold/orange
                                 "#E74C3C",    # Red
                                 "#D979C9",    # Pink
                                 "#9B59B6",    # Purple
                                 "#9F83D4",    # Grape
                                 "#1ABCB4",    # Teal
                                 #"#45A37C",    # Sage green
                                 "#34495E"))   # Slate blue

diana_dend_clust_dichot_rev_ggd <- diana_dend_clust_dichot_rev %>%
  as.ggdend()
```

```{r diana_dichot_rev_cluster_characteristics, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 4}
di_dichot_rev_clusts_kbl <- cluster_pct(diana_dend_clust_dichot_rev_ggd, dichot = TRUE) %>%
  rename(Cluster = cluster_num) %>%
  kable(format = "markdown", align = "rrrr")

di_rev_clust_labs <- cluster_labs(diana_dend_clust_dichot_rev_ggd)
```

```{r diana_dend_clust_dichot_rev, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 6.75, fig.height = 6.75}
ggthemr("flat", spacing = 0.1)

diana_dend_clust_dichot_rev_gg <- ggplot(diana_dend_clust_dichot_rev_ggd, labels = FALSE) +
  geom_text(data = di_rev_clust_labs, aes(x = x_lab, y = -0.15, label = cluster_num, color = cluster_col)) +
  scale_y_reverse() +
  coord_polar(theta = "x") +
  theme(axis.line = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +
  xlab("") +
  ylab("")
diana_dend_clust_dichot_rev_gg

ggthemr("flat")
```