---
title: "Final Project:  Checkpoint 4"
author: "Katherine M. Prioli"
date: "November 26, 2019"
output:
  pdf_document: default
  html_document: default
geometry: margin = 0.5in
---

## **Progress to Date**

The following progress has been made since Checkpoint 3:

### Unsupervised Analysis

* Subset data to variables having $\ge 90%$ complete data, then omitted rows with incomplete data (i.e., omitted all cases having any NAs)
* Selected a random 5% sample of this data, stratified by BMI
* Refactored calculation of dissimilarity matrix to use `vegdist()` instead of `daisy()` (`daisy()` doesn't retain labels in its output object, and those are needed for the visualizations)
* Reran dendrograms based on 5% sample and applied BMI labels
* Generated clustering statistics (within-cluster sum of squares and average silhouette width) for both approaches
* Determined the correct number of clusters to use for both AGNES and DIANA via scree and silhouette plots
  
## **Next Steps**

* 
  
## **Challenges**





```{python libs, echo = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 6}
# Importing libraries

import math
import numpy as np
import pandas as pd
# import xgboost as xgb   # Circle back to this if I have time

from sklearn import ensemble
from sklearn import tree

from sklearn.metrics import confusion_matrix

from sklearn.model_selection import cross_val_score
from sklearn.model_selection import RepeatedKFold
```

```{python import_subset, echo = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 6}
nhanes_f = r.nhanes_sup_trim_dichot
nhanes_feat_f = nhanes_f.drop(["BMI_cat"], axis = 1)
nhanes_labs_f = nhanes_f.filter(["BMI_cat"])
```

```{python nxk_rkf, echo = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 6}
rfc_f = ensemble.RandomForestClassifier(n_estimators = 200, min_samples_leaf = 25, bootstrap = False) #max_depth = 7, 
rkf_f = RepeatedKFold(n_repeats = 10, n_splits = 3)

scores_f = cross_val_score(rfc_f, nhanes_feat_f, nhanes_labs_f.values.ravel(), cv = rkf_f)
scores_f = pd.DataFrame(scores_f)
```

```{r score_rkf, echo = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 6}
scores_final <- py$scores_f %>% 
  unlist() %>% 
  as_tibble() %>% 
  rename(score = value) %>% 
  select(score) %>% 
  mutate(score = as.numeric(score)) %>% 
  summarize(n_runs = n(),
            pct_acc = round(mean(score), digits = 4) * 100,
            sd_acc = (round(sd(score), digits = 4) * 100),
            min_acc = round(min(score), digits = 4) * 100,
            max_acc = round(max(score), digits = 4) * 100)

scores_final_kbl <- scores_final %>% 
  kable(format = "markdown")
scores_final_kbl
```

## **Unsupervised Approach**

For the unsupervised component of this analysis, data was subset to variables with $\ge 90 \%$ non-missing values, then all cases with missing values were dropped.  Since this approach involves visual analysis via dendrograms, the data was subset via a random 5% sample within each BMI category to allow for sensible, interpretable dendrograms.  The analytic dataset thus comprised `r dim(nhanes_unsup)[1]` cases having `r dim(nhanes_unsup)[2]` variables.  To generate dendrograms for agglomerative clustering (AGNES) and divisive clustering (DIANA), a dissimilarity matrix was calculated based on Gower distance.  The Gower distance was chosen because the variables in this dataset are of mixed type (i.e., some continuous, some ordinal, and some nominal).

Descriptives for the dissimilarity matrix:

```{r dissim, echo = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 6}
dissim_mat <- vegdist(nhanes_unsup_mat, method = "gower")
summary(dissim_mat) %>% 
  round(digits = 2) %>% 
  broom::tidy() %>% 
  setNames(., c("Min", "Q1", "Median", "Mean", "Q3", "Max")) %>% 
  kable(format = "markdown")
```

Because the data is likely noisy, AGNES relied on complete (i.e., maximum distance) linkage between clusters and yielded the following dendrogram:

```{r agnes_dend, warning = FALSE, message = FALSE, echo = FALSE, paged.print = FALSE, fig.width = 18, fig.height = 8}
nhanes_agnes <- hclust(d = dissim_mat, method = "ward.D2")

unsup_labs_reord_ag <- unsup_labs[nhanes_agnes$order] %>%    # Reordering leaf labels
  str_sub(start = 1L, end = 1L) %>% 
  as_tibble() %>% 
  mutate(BMI_cat = case_when(   # Modifying leaf labels to show BMI category abbreviations
    value == "1" ~ "UW",        # Underweight
    value == "2" ~ "HW",        # Healthy weight
    value == "3" ~ "OW",        # Overweight
    value == "4" ~ "OB"         # Obese
  )) %>% 
  select(BMI_cat) %>% 
  as.vector()

agnes_dend <- nhanes_agnes %>% 
  as.dendrogram() %>% 
  set("labels", unsup_labs_reord_ag$BMI_cat)

agnes_dend_gg <- agnes_dend %>% 
  ggdendrogram(theme_dendro = FALSE) + #, rotate = TRUE) +   # Landscape by default; rotate becomes portrait but root is at right >:(
   theme(axis.line = element_blank(),
         axis.text.x = element_text(size = 6),
         axis.text.y = element_blank(),
         axis.ticks = element_blank(),
         panel.grid = element_blank()) +
  xlab("") +
  ylab("") +
  ggtitle("AGNES Dendrogram")
agnes_dend_gg
```

DIANA yielded the following dendrogram:

```{r diana_dend, echo = FALSE, warning = FALSE, paged.print = FALSE, fig.width = 12, fig.height = 4}
nhanes_diana <- diana(x = (dissim_mat %>% as.matrix()), diss = TRUE, keep.diss = TRUE) %>% 
  as.hclust()

unsup_labs_reord_di <- unsup_labs[nhanes_diana$order] %>%    # Reordering leaf labels
  str_sub(start = 1L, end = 1L) %>% 
  as_tibble() %>% 
  mutate(BMI_cat = case_when(   # Modifying leaf labels to show BMI category abbreviations
    value == "1" ~ "UW",        # Underweight
    value == "2" ~ "HW",        # Healthy weight
    value == "3" ~ "OW",        # Overweight
    value == "4" ~ "OB"         # Obese
  )) %>% 
  select(BMI_cat) %>% 
  as.vector()

diana_dend <- nhanes_diana %>% 
  as.dendrogram() %>% 
  set("labels", unsup_labs_reord_di$BMI_cat)

diana_dend_gg <- diana_dend %>% 
  ggdendrogram(theme_dendro = FALSE) +
   theme(axis.line = element_blank(),
         axis.text.x = element_text(size = 6),
         axis.text.y = element_blank(),
         axis.ticks = element_blank(),
         panel.grid = element_blank()) +
  xlab("") +
  ylab("") +
  ggtitle("DIANA Dendrogram")
diana_dend_gg
```

```{r clust_stats, echo = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 6}
source(here("clustering_stats.R"), echo = FALSE)
```

For both AGNES and DIANA, cluster size was assessed and within-cluster sums of squares and average silhouette width were calculated based on an upper limit of 15 clusters; these latter two metrics were used to generate scree and silhouette plots.  Cluster sizes were as follows:

```{r clust_sizes, echo = FALSE, paged.print = FALSE, fig.width = 12, fig.height = 4}
agnes_clustsize <- ggplot(data = agnes_sizes, aes(x = cluster_no, y = cluster_size)) +
  geom_col() +
  ylim(0, 40) +
  xlab("Cluster Number") +
  ylab("Cluster Size") +
  ggtitle("AGNES")

agnes_sizedesc <- summary(agnes_sizes$cluster_size) %>% 
  round(digits = 2) %>% 
  broom::tidy() %>% 
  setNames(., c("Min", "Q1", "Median", "Mean", "Q3", "Max")) %>% 
  t() %>% 
  tableGrob(theme = ttheme_minimal(base_size = 10, padding = unit(c(2, 2), "mm")))

diana_clustsize <- ggplot(data = diana_sizes, aes(x = cluster_no, y = cluster_size)) +
  geom_col() +
  ylim(0, 40) +
  xlab("Cluster Number") +
  ylab("Cluster Size") +
  ggtitle("DIANA")

diana_sizedesc <- summary(diana_sizes$cluster_size) %>% 
  round(digits = 2) %>% 
  broom::tidy() %>% 
  setNames(., c("Min", "Q1", "Median", "Mean", "Q3", "Max")) %>% 
  t() %>% 
  tableGrob(theme = ttheme_minimal(base_size = 10, padding = unit(c(2, 2), "mm")))

grid.arrange(agnes_sizedesc, agnes_clustsize, textGrob(" "), diana_sizedesc, diana_clustsize, 
             nrow = 1, ncol = 5, widths = c(0.25, 0.7, 0.1, 0.25, 0.7),
             top = textGrob("Cluster Sizes, k = 15 Clusters, Hierarchical Clustering Analysis",
                            gp = gpar(fontsize = 16, fontface = "bold", col = "#545454"),
                            x = 0.025, hjust = 0))
```

Though neither plot shows an even size distribution across clusters, AGNES' cluster sizes are less varied than those of DIANA.

```{r scree, echo = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 4}
agnes_scree <- ggplot(data = agnes_statdata, aes(x = n_clusters, y = withinss)) +
  geom_line() +
  geom_point() +
  xlab("Number of Clusters") +
  ylab("Within-Cluster Sum of Squares") +
  ggtitle("AGNES")

diana_scree <- ggplot(data = diana_statdata, aes(x = n_clusters, y = withinss)) +
  geom_line() +
  geom_point() +
  xlab("Number of Clusters") +
  ylab("Within-Cluster Sum of Squares") +
  ggtitle("DIANA")

grid.arrange(agnes_scree, diana_scree, nrow = 1,
             top = textGrob("Scree Plots, Hierarchical Clustering Analysis",
                            gp = gpar(fontsize = 16, fontface = "bold", col = "#545454"),
                            x = 0.025, hjust = 0))
```

The AGNES scree plot shows a relatively smooth curve without strong elbows; possible elbows occur at 4 and 7 clusters.  For DIANA, two obvious elbows are seen:  one at 5 clusters and one at 9.

```{r silhou, echo = FALSE, paged.print = FALSE, fig.width = 10, fig.height = 4}
agnes_sil <- ggplot(data = agnes_statdata, aes(x = n_clusters, y = asw)) +
  geom_line() +
  geom_point() +
  xlab("Number of Clusters") +
  ylab("Average Silhouette Width") +
  ggtitle("AGNES")

diana_sil <- ggplot(data = diana_statdata, aes(x = n_clusters, y = asw)) +
  geom_line() +
  geom_point() +
  xlab("Number of Clusters") +
  ylab("Average Silhouette Width") +
  ggtitle("DIANA")

grid.arrange(agnes_sil, diana_sil, nrow = 1,
             top = textGrob("Silhouette Plots, Hierarchical Clustering Analysis",
                            gp = gpar(fontsize = 16, fontface = "bold", col = "#545454"),
                            x = 0.025, hjust = 0))
```

Both the AGNES and DIANA silhouette plots show maximum average silhouette width at 2 clusters, which is unlikely to contain sufficient data to be meaningful.  Other local maxima appear at 6 clusters for AGNES and 5-7 clusters for DIANA.

The AGNES scree and silhouette plots indicate that 7 or 6 clusters respectively may be sufficient.  Since the evidence for 7 clusters is weak per the scree plot, 6 clusters will be chosen for AGNES.  For DIANA, both the scree and silhouette plots indicate that 5 clusters should suffice.